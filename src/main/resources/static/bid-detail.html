<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…ì°° ìƒì„¸</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
        }
        .btn:hover { background: #2980b9; }
        .btn-secondary {
            background: #95a5a6;
        }
        .btn-secondary:hover { background: #7f8c8d; }
        .label { font-weight: bold; color: #555; }
        .value { margin-bottom: 8px; }
        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .price { color: #e74c3c; font-weight: bold; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-active { background: #d4edda; color: #155724; }
        .status-ended { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<div class="header">
    <h1>ğŸ›ï¸ ì…ì°° ìƒì„¸</h1>
    <button class="btn btn-secondary" onclick="history.back()">â† ë’¤ë¡œê°€ê¸°</button>
</div>

<div class="container">
    <div class="card" id="detailCard">
        <h2 id="bidTitle">ê³µê³  ìƒì„¸</h2>
        <div id="bidContent">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="card">
        <h2>ğŸ’° ì…ì°° ì‹ ì²­</h2>
        <form id="bidForm" onsubmit="submitBid(event)">
            <input type="hidden" id="pblancNo">
            <input type="hidden" id="pblancNm">

            <div>
                <label class="label">ì…ì°° ê¸ˆì•¡ (ì›)</label>
                <input type="number" id="bidAmount" placeholder="ì˜ˆ: 10000000" min="1" required>
            </div>
            <div>
                <label class="label">ì…ì°°ì ì´ë¦„ (ì„ íƒ)</label>
                <input type="text" id="bidderName" placeholder="ì‹¤ì œ ì´ë¦„ (ì˜µì…˜)">
            </div>
            <div>
                <label class="label">ì—°ë½ì²˜ (ì„ íƒ)</label>
                <input type="text" id="phoneNumber" placeholder="ì˜ˆ: 010-1234-5678">
            </div>
            <div>
                <label class="label">ì´ë©”ì¼ (ì„ íƒ)</label>
                <input type="email" id="email" placeholder="ì˜ˆ: user@example.com">
            </div>

            <button type="submit" class="btn">ì…ì°°í•˜ê¸°</button>
        </form>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username');

    // code â†’ í•œê¸€ ë©”ì‹œì§€ ë§¤í•‘
    function getBidMessageByCode(code, fallbackMessage) {
        switch (code) {
            case 'AUTH_REQUIRED': return 'ğŸ”‘ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
            case 'BID_NOT_FOUND': return 'âŒ í•´ë‹¹ ê³µê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            case 'PBLANC_NO_REQUIRED': return 'âŒ ê³µê³ ë²ˆí˜¸ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.';
            case 'BID_AMOUNT_INVALID': return 'âŒ ì…ì°° ê¸ˆì•¡ì€ 1ì› ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            default: return fallbackMessage || 'âŒ ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        }
    }

    function formatPriceToManwon(price) {
        if (!price) return '-';
        return (price / 10000).toLocaleString() + 'ë§Œì›';
    }

    // ë‚ ì§œ / ë‚ ì§œ+ì‹œê°„ ì²˜ë¦¬
    function formatDateTime(str) {
        if (!str) return '-';
        const digits = String(str).replace(/\D/g, '');
        if (digits.length < 8) return str; // ì´ìƒí•œ í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ
        const y = digits.slice(0, 4);
        const m = digits.slice(4, 6);
        const d = digits.slice(6, 8);

        if (digits.length >= 12) {
            const hh = digits.slice(8, 10);
            const mm = digits.slice(10, 12);
            return `${y}-${m}-${d} ${hh}:${mm}`;
        }
        return `${y}-${m}-${d}`;
    }

    function getPbctNoFromQuery() {
        const params = new URLSearchParams(location.search);
        return params.get('pbctNo');
    }

    async function loadBidDetail() {
        const pbctNo = getPbctNoFromQuery();
        if (!pbctNo) {
            alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ê³µê³ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
            location.href = '/bids';
            return;
        }

        try {
            const res = await fetch(`/api/bid-detail?pbctNo=${encodeURIComponent(pbctNo)}`);
            const body = await res.json().catch(() => null);

            if (!res.ok || !body || body.success === false) {
                const code = body && body.code ? body.code : 'BID_NOT_FOUND';
                const msg = getBidMessageByCode(code, body && body.message);
                document.getElementById('bidContent').innerHTML = `<p>${msg}</p>`;
                return;
            }

            const bid = body.data;
            document.getElementById('bidTitle').textContent = bid.cltrNm || 'ê³µê³  ìƒì„¸';
            document.getElementById('pblancNo').value = bid.pbctNo || '';
            document.getElementById('pblancNm').value = bid.cltrNm || '';

            const today = new Date().toISOString().slice(0,10).replace(/-/g, '');
            const isActive = bid.pbctEndDt && bid.pbctEndDt >= today;

            const address = [bid.sido, bid.sgk, bid.emd, bid.detailAddress]
                .filter(Boolean)
                .join(' ');

            const bannerHtml = isActive
                ? ''
                : `
                <div style="background:#e8f4ff; color:#2c3e50; padding:12px 16px;
                            border-radius:6px; margin-bottom:16px; font-size:14px;">
                    ì´ ê³µê³ ëŠ” ì´ë¯¸ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒì„¸ ì •ë³´ë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            `;

            document.getElementById('bidContent').innerHTML = `
                ${bannerHtml}
                <div class="value"><span class="label">ê³µê³ ë²ˆí˜¸:</span> ${bid.pbctNo || '-'}</div>
                <div class="value"><span class="label">ì§€ì—­:</span> ${address || '-'}</div>
                <div class="value"><span class="label">ìµœì € ì…ì°°ê°€:</span>
                    <span class="price">${formatPriceToManwon(bid.minBidPrc)}</span></div>
                <div class="value"><span class="label">ê°ì •ê°€:</span>
                    <span class="price">${formatPriceToManwon(bid.apslAsesAvgAmt)}</span></div>
                <div class="value"><span class="label">ì…ì°° ì‹œì‘:</span> ${formatDateTime(bid.pbctBgnDt)}</div>
                <div class="value"><span class="label">ì…ì°° ë§ˆê°:</span> ${formatDateTime(bid.pbctEndDt)}</div>
                <div class="value">
                    <span class="label">ìƒíƒœ:</span>
                    <span class="status ${isActive ? 'status-active' : 'status-ended'}">
                        ${isActive ? 'ì§„í–‰ì¤‘' : 'ë§ˆê°'}
                    </span>
                </div>
            `;
            // â— ì´ì œëŠ” ë§ˆê°ì´ì–´ë„ í¼ì„ ìˆ¨ê¸°ì§€ ì•ŠëŠ”ë‹¤ (ë°ëª¨ìš©ìœ¼ë¡œ í•­ìƒ í™œì„±í™”)

        } catch (e) {
            document.getElementById('bidContent').innerHTML =
                '<p>âŒ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    async function submitBid(event) {
        event.preventDefault();

        if (!token || !username) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = '/login';
            return;
        }

        const pblancNo = document.getElementById('pblancNo').value;
        const pblancNm = document.getElementById('pblancNm').value;
        const bidAmount = parseInt(document.getElementById('bidAmount').value, 10);
        const bidderName = document.getElementById('bidderName').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        const email = document.getElementById('email').value;

        try {
            const res = await fetch('/api/submit-bid', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    pblancNo,
                    pblancNm,
                    bidAmount,
                    bidderName,
                    phoneNumber,
                    email
                })
            });

            const body = await res.json().catch(() => null);

            if (!res.ok || !body || body.success === false) {
                const code = body && body.code ? body.code : 'BID_SUBMIT_ERROR';
                const msg = getBidMessageByCode(code, body && body.message);
                if (res.status === 401 || code === 'AUTH_REQUIRED') {
                    alert(msg);
                    location.href = '/login';
                    return;
                }
                alert(msg);
                return;
            }

            alert(body.message || 'âœ… ì…ì°°ì´ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('bidForm').reset();

        } catch (e) {
            alert('âŒ ì…ì°° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + e.message);
        }
    }

    loadBidDetail();
</script>
</body>
</html>
